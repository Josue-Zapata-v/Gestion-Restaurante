<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Listado de Clientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/css/style-navbar.css}">
    <link rel="stylesheet" th:href="@{/css/style-dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/style-customer.css}">
</head>
<body>

<div th:replace="~{fragment/navbar :: navbar}"></div>

<div class="main-content">
    <div class="customer-main-container">
        <h2 class="customer-header-title">
            <i class="bi bi-people-fill"></i>
            Clientes Registrados
        </h2>

        <!--  Bot贸n que abre el modal para registrar cliente -->
        <button class="btn btn-register-customer mb-4" data-bs-toggle="modal" data-bs-target="#customerFormModal">
            <i class="bi bi-person-plus-fill me-2"></i>
            Registrar Cliente
        </button>

        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <div class="customer-table-card">
            <div class="table-responsive">
                <table class="table customer-table table-striped">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>DNI</th>
                        <th>Nombre Completo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="customer : ${customers}">
                        <td th:text="${customer.idCustomer}" class="customer-id"></td>
                        <td th:text="${customer.dni}" class="customer-dni"></td>
                        <td th:text="${customer.name} + ' ' + ${customer.lastname}"></td>

                        <td>
                            <span th:class="${customer.status} ? 'status-active' : 'status-inactive'"
                                  th:text="${customer.status} ? 'Activo' : 'Inactivo'"></span>
                        </td>

                        <td>
                            <button type="button"
                                    class="btn btn-sm btn-action-edit btn-edit-modal"
                                    data-bs-toggle="modal"
                                    data-bs-target="#customerFormModal"
                                    th:data-id="${customer.idCustomer}"
                                    th:data-dni="${customer.dni}"
                                    th:data-name="${customer.name}"
                                    th:data-lastname="${customer.lastname}"
                                    th:data-status="${customer.status}"
                            >
                                <i class="bi bi-pencil-square"></i> Editar
                            </button>

                            <button type="button"
                                    class="btn btn-sm btn-info btn-assign-table"
                                    data-bs-toggle="modal"
                                    data-bs-target="#assignTableModal"
                                    th:data-customer-id="${customer.idCustomer}"
                                    th:data-customer-name="${customer.name} + ' ' + ${customer.lastname}">
                                <i class="bi bi-table"></i> Asignar Mesa
                            </button>

                            <form th:action="@{/customers/state/{id}/{newState}(id=${customer.idCustomer}, newState=${!customer.status})}"
                                  method="post" style="display:inline;">
                                <button type="submit"
                                        class="btn btn-sm btn-sm-custom"
                                        th:classappend="${customer.status} ? 'btn-danger' : 'btn-success'"
                                        th:text="${customer.status} ? 'Desactivar' : 'Activar'">
                                </button>
                            </form>
                        </td>

                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!--  Modal para Registrar Cliente -->
<div class="modal fade" id="customerFormModal" tabindex="-1" aria-labelledby="customerFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="customerForm" th:action="@{/customers/save}" method="post">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="customerFormModalLabel">Registrar Nuevo Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="idCustomer" name="idCustomer" value="">

                    <div class="mb-3">
                        <label for="dni" class="form-label">DNI</label>
                        <input type="text" id="dni" name="dni" class="form-control" placeholder="Ingrese DNI" required maxlength="8">
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Nombre</label>
                        <input type="text" id="name" name="name" class="form-control" placeholder="Ingrese nombre" required>
                    </div>

                    <div class="mb-3">
                        <label for="lastname" class="form-label">Apellido</label>
                        <input type="text" id="lastname" name="lastname" class="form-control" placeholder="Ingrese apellido" required>
                    </div>

                    <div class="mb-3">
                        <label for="status" class="form-label">Estado</label>
                        <select id="status" name="status" class="form-select" required>
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> <span id="btnSubmitText">Guardar Cliente</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="assignTableModal" tabindex="-1" aria-labelledby="assignTableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="assignTableForm" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="assignTableModalLabel">
                        <i class="bi bi-table me-2"></i> Asignar Mesa
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Se asignar谩 una mesa disponible al cliente:</p>
                    <h5>Cliente: <strong id="clientNamePlaceholder"></strong></h5>

                    <input type="hidden" id="customerIdInput" name="idCustomer">

                    <div class="mb-3 mt-4">
                        <label for="tableSelect" class="form-label fw-bold">Seleccione Mesa Disponible</label>
                        <select id="tableSelect" name="idTable" class="form-select" required>
                            <option value="">-- Seleccionar Mesa --</option>
                            <option th:each="table : ${availableTables}"
                                    th:value="${table.idTable}"
                                    th:text="${'Mesa ' + table.number + ' (Cap. ' + table.capacity + ')'}">
                            </option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle-fill me-1"></i> Confirmar Asignaci贸n
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const customerModal = document.getElementById('customerFormModal');
        const registerButton = document.querySelector('[data-bs-target="#customerFormModal"][data-bs-toggle="modal"]');
        const assignModal = document.getElementById('assignTableModal');
        assignModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;

            // 1. Obtener datos del cliente del bot贸n 'Asignar Mesa'
            const customerId = button.getAttribute('data-customer-id');
            const customerName = button.getAttribute('data-customer-name');

            // 2. Cargar los datos en el modal
            document.getElementById('customerIdInput').value = customerId;
            document.getElementById('clientNamePlaceholder').textContent = customerName;

            // 3. Limpiar la selecci贸n previa de mesa (por si acaso)
            document.getElementById('tableSelect').selectedIndex = 0;

            // La acci贸n del formulario ser谩 actualizada en el evento 'submit'
        });

        // 4. Listener para enviar el formulario y construir la URL de asignaci贸n
        document.getElementById('assignTableForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const customerId = document.getElementById('customerIdInput').value;
            const tableId = document.getElementById('tableSelect').value;

            // Validar que se seleccion贸 una mesa
            if (tableId) {
                // Construimos la URL del endpoint del TableController: /customers/tables/assign/{idCustomer}/{idTable}
                form.action = '/customers/tables/assign/' + customerId + '/' + tableId;
                form.submit(); // Env铆a el formulario POST
            } else {
                alert('Debe seleccionar una mesa disponible para continuar.');
            }
        });

        // 1. Manejar la apertura del modal
        customerModal.addEventListener('show.bs.modal', function(event) {
            // Elemento que dispar贸 el modal (puede ser el bot贸n 'Registrar' o 'Editar')
            const button = event.relatedTarget;

            const modalTitle = customerModal.querySelector('.modal-title');
            const form = customerModal.querySelector('#customerForm');

            // Verificar si el bot贸n disparador tiene atributos de cliente (es decir, es el bot贸n EDITAR)
            if (button && button.classList.contains('btn-edit-modal')) {
                // --- MODO EDICIN ---

                // Obtener los datos del cliente desde los atributos data-* del bot贸n
                const id = button.getAttribute('data-id');
                const dni = button.getAttribute('data-dni');
                const name = button.getAttribute('data-name');
                const lastname = button.getAttribute('data-lastname');
                const status = button.getAttribute('data-status');

                // Cargar los datos en el formulario
                customerModal.querySelector('#idCustomer').value = id;
                customerModal.querySelector('#dni').value = dni;
                customerModal.querySelector('#name').value = name;
                customerModal.querySelector('#lastname').value = lastname;
                customerModal.querySelector('#status').value = status;

                // Actualizar el t铆tulo y el texto del bot贸n
                modalTitle.textContent = 'Editar Cliente ID: ' + id;
                customerModal.querySelector('#btnSubmitText').textContent = 'Guardar Cambios';

            } else {
                // --- MODO REGISTRO ---

                // Limpiar el formulario para un nuevo registro
                form.reset();
                // Asegurar que el ID est茅 vac铆o para que Spring sepa que es un nuevo registro
                customerModal.querySelector('#idCustomer').value = '';

                // Restaurar el t铆tulo y el texto del bot贸n
                modalTitle.textContent = 'Registrar Nuevo Cliente';
                customerModal.querySelector('#btnSubmitText').textContent = 'Guardar Cliente';
            }
        });

        // 2. Manejar el click del bot贸n "Registrar Cliente" (si es necesario unificar la clase)
        if (registerButton) {
            registerButton.setAttribute('data-bs-target', '#customerFormModal');
        }
    });
</script>

<script th:replace="~{fragment/navbar :: navbar-script}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>


